import { Injectable } from '@nestjs/common';
import { BasicCrudService } from '../../../commons/services/crud.service';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Employee } from '../entity/employee.entity';
import { EmployeeDTO } from '../entity/employee.dto';
import { Range } from 'src/api/range/entity/range.entity'
import { cryptText } from 'src/_utils/bcrypt.util';
import { Bank } from 'src/api/bank/entity/bank.entity';
import { BankAccountType } from 'src/api/bank_account_type/entity/bank_account_type.entity';
import { Fintech } from 'src/api/fintech/entity/fintech.entity';

@Injectable()
export class EmployeeService extends BasicCrudService<Employee, string, EmployeeDTO>{

    constructor(
        @InjectRepository(Employee)
        protected repo: Repository<Employee>,
    ) {super();}

    findById(id: string): Promise<Employee>{
        try{
            return this.findOne({where: {uuid:id}});
        } catch(err){
            throw new Error(err.message);
        }
    }

    findByIdentification(id: string): Promise<Employee>{
        try{
            return this.findOne({where: {id}});
        } catch(err){
            throw new Error(err.message);
        }
    }

    buildBaseCreation(dto: EmployeeDTO): Employee{
        //Validations data
        if(! dto) throw new Error('DTO empty');

        //Assign data
        let entity = new Employee();
        entity.name = dto.name;
        entity.id = dto.id;
        entity.phone = dto.phone;
        entity.salary = dto.salary;
        entity.password = cryptText(dto.password);
        entity.state = dto.state;
        entity.bank_account_number = dto.bank_account_number;
        entity.fintech_account_number = dto.fintech_account_number;
        let range = new Range();
        range.uuid = dto.range;
        entity.range = range;
        let bank = new Bank();
        bank.cod = dto.bank;
        entity.bank = bank;
        let bank_account_type = new BankAccountType();
        bank_account_type.cod = dto.bank_account_type;
        entity.bank_account_type = bank_account_type;
        if(dto.fintech){
            let fintech = new Fintech();
            fintech.cod = dto.fintech;
            entity.fintech = fintech;
        }
        return entity;
    }

    async dataValidationBeforeCreate(dto: EmployeeDTO): Promise<void> {
        // Input validations for null values that are required
        // For example validate if not exists for specific(s) properties
        // Example same login, same email, same cod, same nit
    }

    buildBaseEdition(entity: Employee, dto: EmployeeDTO): Employee{
        //Validations data
        if(! dto) throw new Error('DTO empty');
        if(! dto.uuid) throw new Error('Entity id null');

        //Assign data
        entity.name = dto.name ? dto.name : entity.name;
        entity.id = dto.id ? dto.id : entity.id;
        entity.phone = dto.phone ? dto.phone : entity.phone;
        entity.salary = dto.salary ? dto.salary : entity.salary;
        entity.state = dto.state ? dto.state : entity.state;
        entity.bank_account_number = dto.bank_account_number ? dto.bank_account_number : entity.bank_account_number;
        entity.fintech_account_number = dto.fintech_account_number ? dto.fintech_account_number : entity.fintech_account_number;
        let range = new Range();
        range.uuid = dto.range;
        entity.range = dto.range ? range : entity.range;
        let bank = new Bank();
        bank.cod = dto.bank;
        entity.bank = dto.bank ? bank : entity.bank;
        let bank_account_type = new BankAccountType();
        bank_account_type.cod = dto.bank_account_type;
        entity.bank_account_type = dto.bank_account_type ? bank_account_type : entity.bank_account_type;
        let fintech = new Fintech();
        fintech.cod = dto.fintech;
        entity.fintech = dto.fintech ? fintech : entity.fintech;
        return entity;
    }

    async dataValidationBeforeEdit(dto: EmployeeDTO): Promise<void> {
        // Input validations for null values that are required
        // For example validate if not exists for specific(s) properties
        // Example same login, same email, same cod, same nit
    }

}

/** Generated by https://github.com/VictorAndres20 code generator for database, NestJS, React */